<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Data Catalog - DKAN Frontend</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- React and ReactDOM CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    /* Additional custom styles */
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Font Awesome CDN is loaded via HTML head
    // Tailwind CSS is loaded via CDN

    const DataCatalog = () => {
      // Configuration - Replace with your DKAN instance URL
      const DKAN_BASE_URL = 'https://data.medicaid.gov';
      
      // Set to true to use mock data for testing without API connection
      const USE_MOCK_DATA = true;
      
      // Mock data for testing
      const MOCK_DATASETS = [
        {
          identifier: "1",
          title: "National Healthcare Spending Data",
          description: "Comprehensive dataset tracking healthcare spending across all 50 states from 2015-2024. Includes breakdowns by service type, age group, and insurance coverage. Data is updated quarterly and includes both nominal and inflation-adjusted figures.",
          modified: "2024-11-15",
          keyword: ["healthcare", "spending", "economics", "insurance", "medicare"],
          theme: ["Health", "Economics"],
          publisher: { name: "Department of Health & Human Services" },
          distribution: [
            {
              title: "Healthcare Spending CSV",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/health-spending-2024.csv",
              format: "CSV",
              mediaType: "text/csv",
              byteSize: 5242880
            },
            {
              title: "Healthcare Spending JSON",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/health-spending-2024.json",
              format: "JSON",
              mediaType: "application/json",
              byteSize: 8388608
            }
          ],
          contactPoint: {
            fn: "Data Analytics Team",
            hasEmail: "data@hhs.gov"
          },
          license: "Public Domain"
        },
        {
          identifier: "2",
          title: "Medicare Provider Utilization and Payment Data",
          description: "Detailed information about services and procedures provided to Medicare beneficiaries by physicians and other healthcare professionals. Includes data on utilization, payment, and submitted charges organized by National Provider Identifier (NPI), Healthcare Common Procedure Coding System (HCPCS) code, and place of service.",
          modified: "2024-10-01",
          keyword: ["medicare", "providers", "payment", "utilization", "physicians"],
          theme: ["Health", "Government"],
          publisher: { name: "Centers for Medicare & Medicaid Services" },
          distribution: [
            {
              title: "Provider Data 2023",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/provider-utilization-2023.csv",
              format: "CSV",
              mediaType: "text/csv",
              byteSize: 15728640
            }
          ],
          contactPoint: {
            fn: "Medicare Data Team",
            hasEmail: "medicare-data@cms.gov"
          },
          license: "CC0 1.0"
        },
        {
          identifier: "3",
          title: "Prescription Drug Pricing Database",
          description: "National Average Drug Acquisition Cost (NADAC) data for prescription medications. Updated weekly with retail community pharmacy acquisition costs for covered outpatient drugs. Includes drug name, National Drug Code (NDC), pricing effective dates, and unit type.",
          modified: "2024-11-18",
          keyword: ["drugs", "pricing", "pharmacy", "NADAC", "prescription"],
          theme: ["Health", "Commerce"],
          publisher: { name: "Centers for Medicare & Medicaid Services" },
          distribution: [
            {
              title: "Drug Pricing Weekly Update",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/nadac-weekly-2024.csv",
              format: "CSV",
              mediaType: "text/csv",
              byteSize: 3145728
            },
            {
              title: "Drug Pricing API",
              accessURL: "https://data.medicaid.gov/api/1/datastore/query/drug-pricing",
              format: "API",
              mediaType: "application/json"
            }
          ],
          contactPoint: {
            fn: "Drug Pricing Unit",
            hasEmail: "drugpricing@cms.gov"
          },
          license: "Public Domain"
        },
        {
          identifier: "4",
          title: "State Medicaid Enrollment Data",
          description: "Monthly enrollment counts for Medicaid and CHIP programs across all states and territories. Data includes total enrollment, new enrollments, renewals, and terminations. Demographic breakdowns available by age group, gender, and eligibility category.",
          modified: "2024-09-30",
          keyword: ["medicaid", "enrollment", "CHIP", "states", "demographics"],
          theme: ["Health", "Demographics"],
          publisher: { name: "Centers for Medicare & Medicaid Services" },
          distribution: [
            {
              title: "Enrollment Data September 2024",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/enrollment-sep-2024.xlsx",
              format: "XLSX",
              mediaType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
              byteSize: 2097152
            }
          ],
          license: "Public Domain"
        },
        {
          identifier: "5",
          title: "Hospital Quality Measures",
          description: "Quality ratings and performance measures for hospitals participating in Medicare programs. Includes patient experience scores, readmission rates, mortality rates, and safety measures. Data collected through standardized surveys and administrative claims.",
          modified: "2024-08-15",
          keyword: ["hospitals", "quality", "ratings", "patient safety", "outcomes"],
          theme: ["Health", "Quality"],
          publisher: { name: "Centers for Medicare & Medicaid Services" },
          distribution: [
            {
              title: "Hospital Quality Ratings 2024",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/hospital-quality-2024.csv",
              format: "CSV",
              mediaType: "text/csv",
              byteSize: 10485760
            }
          ],
          contactPoint: {
            fn: "Hospital Quality Team",
            hasEmail: "hospitalquality@cms.gov"
          },
          license: "CC0 1.0"
        },
        {
          identifier: "6",
          title: "Long-Term Care Facilities Database",
          description: "Comprehensive directory of nursing homes and long-term care facilities certified for Medicare and Medicaid programs. Includes facility information, ownership data, bed counts, quality ratings, and inspection results.",
          modified: "2024-07-20",
          keyword: ["nursing homes", "long-term care", "facilities", "quality ratings", "elderly care"],
          theme: ["Health", "Senior Services"],
          publisher: { name: "Centers for Medicare & Medicaid Services" },
          distribution: [
            {
              title: "Facility Directory",
              downloadURL: "https://data.medicaid.gov/sites/default/files/dataset/ltc-facilities-2024.csv",
              format: "CSV",
              mediaType: "text/csv",
              byteSize: 7340032
            }
          ],
          license: "Public Domain"
        }
      ];
      
      // State management
      const [view, setView] = useState('home'); // home, browse, detail
      const [datasets, setDatasets] = useState([]);
      const [filteredDatasets, setFilteredDatasets] = useState([]);
      const [selectedDataset, setSelectedDataset] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [filters, setFilters] = useState({
        theme: '',
        keyword: '',
        publisher: ''
      });
      const [availableThemes, setAvailableThemes] = useState([]);
      const [availablePublishers, setAvailablePublishers] = useState([]);
      const [csvPreview, setCsvPreview] = useState({}); // Store CSV previews by resource index
      const [loadingCsv, setLoadingCsv] = useState({});
      const [csvError, setCsvError] = useState({});

      // Fetch and parse CSV preview
      const fetchCsvPreview = async (url, resourceIndex) => {
        setLoadingCsv(prev => ({ ...prev, [resourceIndex]: true }));
        setCsvError(prev => ({ ...prev, [resourceIndex]: null }));
        
        try {
          // For mock data, generate sample CSV data
          if (USE_MOCK_DATA) {
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Generate mock CSV data based on the resource type
            const mockData = {
              data: [
                { 'State': 'California', 'Year': '2024', 'Spending': '$45.2B', 'Beneficiaries': '14.2M', 'Change': '+3.2%' },
                { 'State': 'Texas', 'Year': '2024', 'Spending': '$38.7B', 'Beneficiaries': '10.8M', 'Change': '+2.8%' },
                { 'State': 'Florida', 'Year': '2024', 'Spending': '$35.1B', 'Beneficiaries': '9.5M', 'Change': '+4.1%' },
                { 'State': 'New York', 'Year': '2024', 'Spending': '$42.8B', 'Beneficiaries': '8.9M', 'Change': '+2.5%' },
                { 'State': 'Pennsylvania', 'Year': '2024', 'Spending': '$28.3B', 'Beneficiaries': '7.2M', 'Change': '+3.0%' },
              ],
              meta: {
                fields: ['State', 'Year', 'Spending', 'Beneficiaries', 'Change']
              }
            };
            
            setCsvPreview(prev => ({ ...prev, [resourceIndex]: mockData }));
            setLoadingCsv(prev => ({ ...prev, [resourceIndex]: false }));
            return;
          }
          
          // Real CSV fetch and parse
          Papa.parse(url, {
            download: true,
            header: true,
            preview: 10, // Only load first 10 rows
            complete: (results) => {
              setCsvPreview(prev => ({ ...prev, [resourceIndex]: results }));
              setLoadingCsv(prev => ({ ...prev, [resourceIndex]: false }));
            },
            error: (error) => {
              console.error('CSV parsing error:', error);
              setCsvError(prev => ({ ...prev, [resourceIndex]: 'Failed to load CSV preview' }));
              setLoadingCsv(prev => ({ ...prev, [resourceIndex]: false }));
            }
          });
        } catch (err) {
          console.error('Error fetching CSV:', err);
          setCsvError(prev => ({ ...prev, [resourceIndex]: err.message }));
          setLoadingCsv(prev => ({ ...prev, [resourceIndex]: false }));
        }
      };

      // Fetch datasets from DKAN
      const fetchDatasets = async (query = '') => {
        setLoading(true);
        setError(null);
        
        try {
          // Use mock data if enabled
          if (USE_MOCK_DATA) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 500));
            
            let results = MOCK_DATASETS;
            
            // Filter by query if provided
            if (query) {
              const lowerQuery = query.toLowerCase();
              results = MOCK_DATASETS.filter(d => 
                d.title.toLowerCase().includes(lowerQuery) ||
                d.description.toLowerCase().includes(lowerQuery) ||
                d.keyword.some(k => k.toLowerCase().includes(lowerQuery))
              );
            }
            
            setDatasets(results);
            setFilteredDatasets(results);
            
            // Extract unique themes and publishers for filters
            const themes = [...new Set(results.flatMap(d => d.theme || []))];
            const publishers = [...new Set(results.map(d => d.publisher?.name).filter(Boolean))];
            
            setAvailableThemes(themes);
            setAvailablePublishers(publishers);
            setLoading(false);
            return;
          }
          
          // Real API call
          const searchUrl = query 
            ? `${DKAN_BASE_URL}/api/1/search?fulltext=${encodeURIComponent(query)}`
            : `${DKAN_BASE_URL}/api/1/search`;
          
          console.log('Fetching from:', searchUrl);
          
          const response = await fetch(searchUrl);
          
          if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log('API Response:', data);
          
          const results = data.results || [];
          
          setDatasets(results);
          setFilteredDatasets(results);
          
          // Extract unique themes and publishers for filters
          const themes = [...new Set(results.flatMap(d => d.theme || []))];
          const publishers = [...new Set(results.map(d => d.publisher?.name).filter(Boolean))];
          
          setAvailableThemes(themes);
          setAvailablePublishers(publishers);
          
        } catch (err) {
          console.error('Error fetching datasets:', err);
          setError(`Unable to load datasets: ${err.message}. ${USE_MOCK_DATA ? '' : 'Try enabling USE_MOCK_DATA for testing.'}`);
        } finally {
          setLoading(false);
        }
      };

      // Fetch dataset details
      const fetchDatasetDetails = async (datasetId) => {
        setLoading(true);
        setError(null);
        
        try {
          // Use mock data if enabled
          if (USE_MOCK_DATA) {
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const dataset = MOCK_DATASETS.find(d => d.identifier === datasetId);
            if (!dataset) {
              throw new Error('Dataset not found');
            }
            
            setSelectedDataset(dataset);
            setLoading(false);
            return;
          }
          
          // Real API call
          const detailUrl = `${DKAN_BASE_URL}/api/1/metastore/schemas/dataset/items/${datasetId}`;
          console.log('Fetching details from:', detailUrl);
          
          const response = await fetch(detailUrl);
          
          if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log('Dataset details:', data);
          
          setSelectedDataset(data);
          
        } catch (err) {
          console.error('Error fetching dataset details:', err);
          setError(`Unable to load dataset details: ${err.message}`);
        } finally {
          setLoading(false);
        }
      };

      // Apply filters
      useEffect(() => {
        let filtered = [...datasets];
        
        if (filters.theme) {
          filtered = filtered.filter(d => 
            d.theme && d.theme.includes(filters.theme)
          );
        }
        
        if (filters.keyword) {
          filtered = filtered.filter(d => 
            d.keyword && d.keyword.some(k => 
              k.toLowerCase().includes(filters.keyword.toLowerCase())
            )
          );
        }
        
        if (filters.publisher) {
          filtered = filtered.filter(d => 
            d.publisher?.name === filters.publisher
          );
        }
        
        setFilteredDatasets(filtered);
      }, [filters, datasets]);

      // Handle search
      const handleSearch = (e) => {
        e.preventDefault();
        fetchDatasets(searchQuery);
        setView('browse');
      };

      // Handle dataset selection
      const handleDatasetClick = async (dataset) => {
        await fetchDatasetDetails(dataset.identifier);
        setView('detail');
      };

      // Format date
      const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      };

      // Format file size
      const formatFileSize = (bytes) => {
        if (!bytes) return 'N/A';
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
      };

      // Components
      const Header = () => (
        <>
          {USE_MOCK_DATA && (
            <div className="bg-yellow-100 border-b-2 border-yellow-400 px-4 py-2 text-center">
              <div className="container mx-auto flex items-center justify-center space-x-2 text-sm text-yellow-900">
                <i className="fas fa-info-circle"></i>
                <span className="font-medium">Demo Mode: Using sample data</span>
                <span className="text-yellow-700">â€¢</span>
                <span>Set USE_MOCK_DATA = false in code to connect to real DKAN instance</span>
              </div>
            </div>
          )}
          <header className="bg-blue-700 text-white shadow-lg">
          <div className="container mx-auto px-4 py-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <i className="fas fa-database text-3xl"></i>
                <div>
                  <h1 
                    className="text-2xl font-bold cursor-pointer hover:text-blue-100 transition"
                    onClick={() => setView('home')}
                  >
                    Open Data Catalog
                  </h1>
                  <p className="text-blue-100 text-sm">Discover, explore, and download public datasets</p>
                </div>
              </div>
              <nav className="flex space-x-6">
                <button
                  onClick={() => setView('home')}
                  className="hover:text-blue-100 transition flex items-center space-x-2"
                >
                  <i className="fas fa-home"></i>
                  <span>Home</span>
                </button>
                <button
                  onClick={() => {
                    setView('browse');
                    if (datasets.length === 0) fetchDatasets();
                  }}
                  className="hover:text-blue-100 transition flex items-center space-x-2"
                >
                  <i className="fas fa-list"></i>
                  <span>Browse Datasets</span>
                </button>
                <a
                  href={`${DKAN_BASE_URL}/about/api`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="hover:text-blue-100 transition flex items-center space-x-2"
                >
                  <i className="fas fa-code"></i>
                  <span>API</span>
                </a>
              </nav>
            </div>
          </div>
        </header>
        </>
      );

      const SearchBar = ({ large = false }) => (
        <form onSubmit={handleSearch} className="w-full">
          <div className={`relative ${large ? 'max-w-3xl mx-auto' : ''}`}>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search datasets by keyword, topic, or publisher..."
              className={`w-full px-6 py-4 pr-14 rounded-lg border-2 border-gray-300 focus:border-blue-500 focus:outline-none text-gray-800 ${
                large ? 'text-lg' : ''
              }`}
            />
            <button
              type="submit"
              className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition"
            >
              <i className="fas fa-search"></i>
            </button>
          </div>
        </form>
      );

      const HomePage = () => (
        <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white">
          <div className="container mx-auto px-4 py-20">
            <div className="text-center mb-12">
              <h2 className="text-5xl font-bold text-gray-900 mb-4">
                Welcome to the Open Data Catalog
              </h2>
              <p className="text-xl text-gray-600 max-w-2xl mx-auto">
                Access, analyze, and download public datasets to drive innovation and transparency
              </p>
            </div>

            <div className="mb-16">
              <SearchBar large={true} />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
              <div className="bg-white p-8 rounded-lg shadow-lg hover:shadow-xl transition">
                <div className="text-blue-600 text-4xl mb-4">
                  <i className="fas fa-search-plus"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Discover Data</h3>
                <p className="text-gray-600">
                  Search through thousands of datasets with powerful filtering and faceted search
                </p>
              </div>

              <div className="bg-white p-8 rounded-lg shadow-lg hover:shadow-xl transition">
                <div className="text-green-600 text-4xl mb-4">
                  <i className="fas fa-chart-bar"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Visualize Insights</h3>
                <p className="text-gray-600">
                  Preview data and explore datasets with interactive tables and visualizations
                </p>
              </div>

              <div className="bg-white p-8 rounded-lg shadow-lg hover:shadow-xl transition">
                <div className="text-purple-600 text-4xl mb-4">
                  <i className="fas fa-download"></i>
                </div>
                <h3 className="text-xl font-semibold text-gray-900 mb-2">Download & Use</h3>
                <p className="text-gray-600">
                  Access data in multiple formats through direct downloads or programmatic APIs
                </p>
              </div>
            </div>

            <div className="text-center mt-16">
              <button
                onClick={() => {
                  setView('browse');
                  fetchDatasets();
                }}
                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg text-lg font-semibold transition shadow-lg hover:shadow-xl inline-flex items-center space-x-2"
              >
                <span>Browse All Datasets</span>
                <i className="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      );

      const FilterSidebar = () => (
        <div className="bg-white rounded-lg shadow p-6 sticky top-4">
          <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i className="fas fa-filter mr-2 text-blue-600"></i>
            Filters
          </h3>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Theme
              </label>
              <select
                value={filters.theme}
                onChange={(e) => setFilters({ ...filters, theme: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
              >
                <option value="">All Themes</option>
                {availableThemes.map(theme => (
                  <option key={theme} value={theme}>{theme}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Publisher
              </label>
              <select
                value={filters.publisher}
                onChange={(e) => setFilters({ ...filters, publisher: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
              >
                <option value="">All Publishers</option>
                {availablePublishers.map(publisher => (
                  <option key={publisher} value={publisher}>{publisher}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Keyword
              </label>
              <input
                type="text"
                value={filters.keyword}
                onChange={(e) => setFilters({ ...filters, keyword: e.target.value })}
                placeholder="Filter by keyword..."
                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
              />
            </div>

            {(filters.theme || filters.publisher || filters.keyword) && (
              <button
                onClick={() => setFilters({ theme: '', keyword: '', publisher: '' })}
                className="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-md transition text-sm"
              >
                Clear Filters
              </button>
            )}
          </div>

          <div className="mt-6 pt-6 border-t border-gray-200">
            <p className="text-sm text-gray-600">
              <i className="fas fa-info-circle mr-1"></i>
              Showing {filteredDatasets.length} of {datasets.length} datasets
            </p>
          </div>
        </div>
      );

      const DatasetCard = ({ dataset }) => (
        <div
          onClick={() => handleDatasetClick(dataset)}
          className="bg-white rounded-lg shadow hover:shadow-xl transition cursor-pointer p-6 border-l-4 border-blue-500"
        >
          <div className="flex items-start justify-between mb-3">
            <h3 className="text-xl font-semibold text-gray-900 hover:text-blue-600 transition flex-1">
              {dataset.title}
            </h3>
            <i className="fas fa-chevron-right text-gray-400 ml-4"></i>
          </div>

          <p className="text-gray-600 mb-4 line-clamp-3">
            {dataset.description || 'No description available'}
          </p>

          <div className="flex flex-wrap gap-2 mb-4">
            {dataset.keyword && dataset.keyword.slice(0, 5).map((keyword, idx) => (
              <span
                key={idx}
                className="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full"
              >
                {keyword}
              </span>
            ))}
          </div>

          <div className="flex items-center justify-between text-sm text-gray-500">
            <div className="flex items-center space-x-4">
              <span className="flex items-center">
                <i className="fas fa-building mr-2"></i>
                {dataset.publisher?.name || 'Unknown Publisher'}
              </span>
              <span className="flex items-center">
                <i className="fas fa-calendar mr-2"></i>
                {formatDate(dataset.modified)}
              </span>
            </div>
            {dataset.distribution && dataset.distribution.length > 0 && (
              <span className="flex items-center text-green-600">
                <i className="fas fa-file-download mr-2"></i>
                {dataset.distribution.length} resource{dataset.distribution.length !== 1 ? 's' : ''}
              </span>
            )}
          </div>
        </div>
      );

      const BrowsePage = () => (
        <div className="bg-gray-50 min-h-screen">
          <div className="container mx-auto px-4 py-8">
            <div className="mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-4">Browse Datasets</h2>
              <SearchBar />
            </div>

            {loading && (
              <div className="text-center py-20">
                <i className="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
                <p className="mt-4 text-gray-600">Loading datasets...</p>
              </div>
            )}

            {error && (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <div className="flex items-center">
                  <i className="fas fa-exclamation-circle text-red-500 mr-3"></i>
                  <p className="text-red-700">{error}</p>
                </div>
              </div>
            )}

            {!loading && !error && (
              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div className="lg:col-span-1">
                  <FilterSidebar />
                </div>

                <div className="lg:col-span-3">
                  {filteredDatasets.length === 0 ? (
                    <div className="bg-white rounded-lg shadow p-12 text-center">
                      <i className="fas fa-search text-6xl text-gray-300 mb-4"></i>
                      <h3 className="text-xl font-semibold text-gray-900 mb-2">No datasets found</h3>
                      <p className="text-gray-600">Try adjusting your filters or search query</p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {filteredDatasets.map((dataset, idx) => (
                        <DatasetCard key={dataset.identifier || idx} dataset={dataset} />
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );

      const DatasetDetailPage = () => {
        if (!selectedDataset) return null;

        // CSV Preview Component
        const CsvPreviewTable = ({ data, resourceIndex }) => {
          if (!data || !data.data || data.data.length === 0) {
            return null;
          }

          const headers = data.meta.fields || Object.keys(data.data[0]);

          return (
            <div className="mt-4 bg-gray-50 rounded-lg p-4">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-gray-700 flex items-center">
                  <i className="fas fa-table mr-2 text-blue-600"></i>
                  Data Preview (First 10 rows)
                </h4>
                <span className="text-xs text-gray-500">
                  {data.data.length} rows shown
                </span>
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200 text-sm">
                  <thead className="bg-gray-100">
                    <tr>
                      {headers.map((header, idx) => (
                        <th
                          key={idx}
                          className="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider whitespace-nowrap"
                        >
                          {header}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {data.data.map((row, rowIdx) => (
                      <tr key={rowIdx} className="hover:bg-gray-50">
                        {headers.map((header, colIdx) => (
                          <td
                            key={colIdx}
                            className="px-4 py-3 whitespace-nowrap text-gray-900"
                          >
                            {row[header] || '-'}
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="mt-3 text-xs text-gray-500 flex items-center">
                <i className="fas fa-info-circle mr-2"></i>
                This is a preview of the first 10 rows. Download the full dataset to see all data.
              </div>
            </div>
          );
        };

        return (
          <div className="bg-gray-50 min-h-screen">
            <div className="container mx-auto px-4 py-8">
              <button
                onClick={() => setView('browse')}
                className="mb-6 text-blue-600 hover:text-blue-700 flex items-center space-x-2"
              >
                <i className="fas fa-arrow-left"></i>
                <span>Back to Browse</span>
              </button>

              <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-8">
                  <h1 className="text-3xl font-bold mb-2">{selectedDataset.title}</h1>
                  <p className="text-blue-100">
                    Published by {selectedDataset.publisher?.name || 'Unknown Publisher'}
                  </p>
                </div>

                <div className="p-8">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div className="bg-blue-50 p-4 rounded-lg">
                      <div className="text-blue-600 text-sm font-medium mb-1">Modified</div>
                      <div className="text-gray-900 font-semibold">
                        {formatDate(selectedDataset.modified)}
                      </div>
                    </div>
                    <div className="bg-green-50 p-4 rounded-lg">
                      <div className="text-green-600 text-sm font-medium mb-1">Resources</div>
                      <div className="text-gray-900 font-semibold">
                        {selectedDataset.distribution?.length || 0}
                      </div>
                    </div>
                    <div className="bg-purple-50 p-4 rounded-lg">
                      <div className="text-purple-600 text-sm font-medium mb-1">License</div>
                      <div className="text-gray-900 font-semibold">
                        {selectedDataset.license || 'Not specified'}
                      </div>
                    </div>
                  </div>

                  <section className="mb-8">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                      <i className="fas fa-info-circle mr-3 text-blue-600"></i>
                      Description
                    </h2>
                    <p className="text-gray-700 leading-relaxed">
                      {selectedDataset.description || 'No description available'}
                    </p>
                  </section>

                  {selectedDataset.keyword && selectedDataset.keyword.length > 0 && (
                    <section className="mb-8">
                      <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                        <i className="fas fa-tags mr-3 text-blue-600"></i>
                        Keywords
                      </h2>
                      <div className="flex flex-wrap gap-2">
                        {selectedDataset.keyword.map((keyword, idx) => (
                          <span
                            key={idx}
                            className="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium"
                          >
                            {keyword}
                          </span>
                        ))}
                      </div>
                    </section>
                  )}

                  {selectedDataset.distribution && selectedDataset.distribution.length > 0 && (
                    <section className="mb-8">
                      <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                        <i className="fas fa-download mr-3 text-blue-600"></i>
                        Download Resources
                      </h2>
                      <div className="space-y-3">
                        {selectedDataset.distribution.map((dist, idx) => {
                          const isCSV = dist.format?.toUpperCase() === 'CSV' || 
                                        dist.mediaType?.includes('csv') ||
                                        dist.downloadURL?.toLowerCase().endsWith('.csv');
                          
                          return (
                            <div
                              key={idx}
                              className="border border-gray-200 rounded-lg p-4 hover:border-blue-500 transition"
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <h3 className="font-semibold text-gray-900 mb-1">
                                    {dist.title || `Resource ${idx + 1}`}
                                  </h3>
                                  <div className="flex items-center space-x-4 text-sm text-gray-600">
                                    <span className="flex items-center">
                                      <i className="fas fa-file mr-2"></i>
                                      {dist.format || dist.mediaType || 'Unknown format'}
                                    </span>
                                    {dist.byteSize && (
                                      <span className="flex items-center">
                                        <i className="fas fa-hdd mr-2"></i>
                                        {formatFileSize(dist.byteSize)}
                                      </span>
                                    )}
                                  </div>
                                </div>
                                <div className="flex items-center space-x-2">
                                  {isCSV && (
                                    <button
                                      onClick={() => {
                                        if (csvPreview[idx]) {
                                          // Clear preview
                                          setCsvPreview(prev => {
                                            const newPrev = { ...prev };
                                            delete newPrev[idx];
                                            return newPrev;
                                          });
                                        } else {
                                          // Load preview
                                          fetchCsvPreview(dist.downloadURL || dist.accessURL, idx);
                                        }
                                      }}
                                      className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md transition inline-flex items-center space-x-2 text-sm"
                                    >
                                      <i className={`fas fa-${csvPreview[idx] ? 'eye-slash' : 'eye'}`}></i>
                                      <span>{csvPreview[idx] ? 'Hide' : 'Preview'}</span>
                                    </button>
                                  )}
                                  {dist.downloadURL && (
                                    <a
                                      href={dist.downloadURL}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition inline-flex items-center space-x-2"
                                    >
                                      <i className="fas fa-download"></i>
                                      <span>Download</span>
                                    </a>
                                  )}
                                  {!dist.downloadURL && dist.accessURL && (
                                    <a
                                      href={dist.accessURL}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition inline-flex items-center space-x-2"
                                    >
                                      <i className="fas fa-external-link-alt"></i>
                                      <span>Access</span>
                                    </a>
                                  )}
                                </div>
                              </div>
                              
                              {/* CSV Preview Loading State */}
                              {loadingCsv[idx] && (
                                <div className="mt-4 text-center py-8">
                                  <i className="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                                  <p className="mt-2 text-gray-600 text-sm">Loading preview...</p>
                                </div>
                              )}
                              
                              {/* CSV Preview Error */}
                              {csvError[idx] && (
                                <div className="mt-4 bg-red-50 border-l-4 border-red-500 p-3 rounded text-sm">
                                  <p className="text-red-700">{csvError[idx]}</p>
                                </div>
                              )}
                              
                              {/* CSV Preview Table */}
                              {csvPreview[idx] && !loadingCsv[idx] && !csvError[idx] && (
                                <CsvPreviewTable data={csvPreview[idx]} resourceIndex={idx} />
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </section>
                  )}

                  {selectedDataset.contactPoint && (
                    <section className="mb-8">
                      <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                        <i className="fas fa-envelope mr-3 text-blue-600"></i>
                        Contact Information
                      </h2>
                      <div className="bg-gray-50 p-4 rounded-lg">
                        {selectedDataset.contactPoint.fn && (
                          <p className="text-gray-700 mb-2">
                            <strong>Name:</strong> {selectedDataset.contactPoint.fn}
                          </p>
                        )}
                        {selectedDataset.contactPoint.hasEmail && (
                          <p className="text-gray-700">
                            <strong>Email:</strong>{' '}
                            <a
                              href={`mailto:${selectedDataset.contactPoint.hasEmail}`}
                              className="text-blue-600 hover:underline"
                            >
                              {selectedDataset.contactPoint.hasEmail}
                            </a>
                          </p>
                        )}
                      </div>
                    </section>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Main render
      return (
        <div className="min-h-screen bg-gray-50">
          <Header />
          
          <main>
            {view === 'home' && <HomePage />}
            {view === 'browse' && <BrowsePage />}
            {view === 'detail' && <DatasetDetailPage />}
          </main>

          <footer className="bg-gray-800 text-white py-8 mt-16">
            <div className="container mx-auto px-4 text-center">
              <p className="text-gray-400">
                &copy; 2025 Open Data Catalog. Built with React, Tailwind CSS, and DKAN API.
              </p>
              <div className="mt-4 flex justify-center space-x-6">
                <a href="#" className="text-gray-400 hover:text-white transition">
                  <i className="fab fa-github text-xl"></i>
                </a>
                <a href="#" className="text-gray-400 hover:text-white transition">
                  <i className="fab fa-twitter text-xl"></i>
                </a>
                <a href="#" className="text-gray-400 hover:text-white transition">
                  <i className="fas fa-rss text-xl"></i>
                </a>
              </div>
            </div>
          </footer>
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DataCatalog />);
  </script>
</body>
</html>
