# DKAN Client Tools - Build Architecture Diagrams

## 1. Directory Structure Overview

```
dkanClientTools (Root - npm workspace)
│
├── packages/ (3 core packages - use tsup)
│   ├── dkan-client-tools-core/
│   │   ├── src/
│   │   ├── tsup.config.ts
│   │   └── dist/
│   │       ├── index.js (35KB ESM)
│   │       ├── index.cjs (35KB CJS)
│   │       ├── index.global.js (103KB IIFE)
│   │       └── index.global.min.js (40KB IIFE) ← Used in Drupal
│   │
│   ├── dkan-client-tools-react/
│   │   ├── src/
│   │   ├── tsup.config.ts
│   │   └── dist/
│   │       ├── index.js (1.1MB ESM)
│   │       ├── index.cjs (1.1MB CJS)
│   │       ├── index.global.js (409KB IIFE)
│   │       └── index.global.min.js (205KB IIFE) ← Used in Drupal
│   │
│   └── dkan-client-tools-vue/
│       ├── src/
│       ├── tsup.config.ts
│       └── dist/
│           ├── index.js (21KB ESM)
│           ├── index.cjs (25KB CJS)
│           ├── index.global.full.min.js (240KB IIFE) ← Used in Drupal
│           └── index-runtime.global.runtime.min.js (174KB IIFE) ← Used in Drupal
│
├── examples/ (Standalone apps + symlinks to Drupal modules)
│   ├── react-demo-app/
│   ├── vue-demo-app/
│   ├── vanilla-demo-app/
│   ├── drupal-base-modules/ (symlinks)
│   │   ├── core → ../../dkan/docroot/modules/custom/dkan_client_tools_core_base
│   │   ├── react → ../../dkan/docroot/modules/custom/dkan_client_tools_react_base
│   │   └── vue → ../../dkan/docroot/modules/custom/dkan_client_tools_vue_base
│   ├── drupal-demo-module-vanilla → ../dkan/docroot/modules/custom/dkan_client_demo_vanilla
│   ├── drupal-demo-module-react → ../dkan/docroot/modules/custom/dkan_client_demo_react
│   └── drupal-demo-module-vue → ../dkan/docroot/modules/custom/dkan_client_demo_vue
│
└── dkan/ (Drupal site with DDEV)
    └── docroot/modules/custom/ (6 Drupal modules)
        ├── dkan_client_tools_core_base/ (Base library)
        │   ├── dkan_client_tools_core_base.info.yml
        │   ├── dkan_client_tools_core_base.libraries.yml
        │   └── js/vendor/
        │       └── dkan-client-tools-core.min.js (40KB)
        │
        ├── dkan_client_tools_react_base/ (Base library)
        │   ├── dkan_client_tools_react_base.info.yml
        │   ├── dkan_client_tools_react_base.libraries.yml
        │   └── js/vendor/
        │       └── dkan-client-tools-react.min.js (205KB)
        │
        ├── dkan_client_tools_vue_base/ (Base library)
        │   ├── dkan_client_tools_vue_base.info.yml
        │   ├── dkan_client_tools_vue_base.libraries.yml
        │   └── js/vendor/
        │       ├── dkan-client-tools-vue.min.js (240KB)
        │       └── dkan-client-tools-vue-runtime.min.js (174KB)
        │
        ├── dkan_client_demo_vanilla/ (Demo - no build)
        │   ├── src/Plugin/Block/
        │   ├── js/
        │   ├── css/
        │   └── Dependencies: dkan_client_tools_core_base
        │
        ├── dkan_client_demo_react/ (Demo - Vite build)
        │   ├── package.json
        │   ├── vite.config.js
        │   ├── src/jsx/
        │   ├── js/
        │   │   └── dataset-search-widget.min.js (Generated by Vite)
        │   └── Dependencies: dkan_client_tools_react_base
        │
        └── dkan_client_demo_vue/ (Demo - Vite build)
            ├── package.json
            ├── vite.config.js
            ├── src/
            ├── js/
            │   └── dataset-search-component.js (Generated by Vite)
            └── Dependencies: dkan_client_tools_vue_base
```

---

## 2. Build Flow Diagram

```
NPM Monorepo Build (tsup)
════════════════════════════════════════════════════════════════

packages/dkan-client-tools-core/src/
    ↓ npm run build (tsup)
packages/dkan-client-tools-core/dist/
    ├── index.js (35KB ESM)
    ├── index.cjs (35KB CJS)
    ├── index.global.js (103KB)
    └── index.global.min.js (40KB) ← MANUALLY COPY TO DRUPAL
         ↓
    dkan/docroot/modules/custom/dkan_client_tools_core_base/js/vendor/
         └── dkan-client-tools-core.min.js


packages/dkan-client-tools-react/src/
    ↓ npm run build (tsup)
packages/dkan-client-tools-react/dist/
    ├── index.js (1.1MB ESM)
    ├── index.cjs (1.1MB CJS)
    ├── index.global.js (409KB)
    └── index.global.min.js (205KB) ← MANUALLY COPY TO DRUPAL
         ↓
    dkan/docroot/modules/custom/dkan_client_tools_react_base/js/vendor/
         └── dkan-client-tools-react.min.js


packages/dkan-client-tools-vue/src/
    ↓ npm run build (tsup - 5 configs)
packages/dkan-client-tools-vue/dist/
    ├── index.global.full.min.js (240KB) ← MANUALLY COPY TO DRUPAL
    │    ↓
    │   dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/
    │       └── dkan-client-tools-vue.min.js
    │
    └── index-runtime.global.runtime.min.js (174KB) ← MANUALLY COPY TO DRUPAL
         ↓
        dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/
             └── dkan-client-tools-vue-runtime.min.js


Demo Module Builds (Vite)
════════════════════════════════════════════════════════════════

dkan_client_demo_react/src/jsx/
    ↓ npm run build (Vite, externalizes React libs)
dkan_client_demo_react/js/
    └── dataset-search-widget.min.js (486KB, bundles React Query + widget)


dkan_client_demo_vue/src/
    ↓ npm run build (Vite, pre-compiles Vue SFCs)
dkan_client_demo_vue/js/
    └── dataset-search-component.js (250KB, pre-compiled template)
```

---

## 3. Dependency Graph

```
Drupal Module Dependencies
══════════════════════════════════════════════════════════════

dkan_client_demo_vanilla
    ↓ depends on
dkan_client_tools_core_base
    └─ provides: window.DkanClientTools


dkan_client_demo_react
    ↓ depends on
dkan_client_tools_react_base
    └─ provides: window.DkanClientToolsReact
        (includes React, ReactDOM, React Query)
    
    Also depends on:
    dkan_client_tools_core_base (transitively)
        └─ provides: window.DkanClientTools


dkan_client_demo_vue
    ↓ depends on
dkan_client_tools_vue_base
    └─ provides: window.DkanClientToolsVue
        (includes Vue 3, Vue Query)
    
    Also depends on:
    dkan_client_tools_core_base (transitively)
        └─ provides: window.DkanClientTools


NPM Monorepo Dependencies
══════════════════════════════════════════════════════════════

dkan-client-tools-react (package)
    ↓ depends on
dkan-client-tools-core (package)


dkan-client-tools-vue (package)
    ↓ depends on
dkan-client-tools-core (package)


demo module packages (dkan_client_demo_react, dkan_client_demo_vue)
    ↓ depend on
    
    dkan-client-tools-react / dkan-client-tools-vue
        (via file: protocol symlink)


examples/react-demo-app
    ↓ depends on
dkan-client-tools-react


examples/vue-demo-app
    ↓ depends on
dkan-client-tools-vue


examples/vanilla-demo-app
    ↓ depends on
dkan-client-tools-core
```

---

## 4. Build Tool Matrix

```
┌──────────────────────────────────────────────────────────────────┐
│ Build Tool Analysis                                              │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ packages/dkan-client-tools-core              Build Tool: tsup    │
│   Format: ESM/CJS/IIFE                       Config: tsup.config │
│   Minified IIFE: 40KB                        Dev Tool: TypeScript│
│                                                                  │
│ packages/dkan-client-tools-react            Build Tool: tsup    │
│   Format: ESM/CJS/IIFE (self-contained)      Config: tsup.config │
│   Minified IIFE: 205KB (w/ React bundled)   Dev Tool: TypeScript│
│                                                                  │
│ packages/dkan-client-tools-vue              Build Tool: tsup    │
│   Format: ESM/CJS/IIFE (multiple variants)   Config: tsup.config │
│   Minified IIFE: 240KB (full) | 174KB (rt)  Dev Tool: TypeScript│
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ dkan_client_demo_vanilla                    Build Tool: (none)  │
│   Uses prebuilt core library                Format: Plain JS    │
│                                                                  │
│ dkan_client_demo_react                      Build Tool: Vite    │
│   Bundles widget with React Query           Config: vite.config │
│   Source: JSX (React syntax)                Dev Tool: Node 20+  │
│   Externals: React libs from base module    Output: IIFE 486KB  │
│                                                                  │
│ dkan_client_demo_vue                        Build Tool: Vite    │
│   Pre-compiles Vue SFCs to render funcs     Config: vite.config │
│   Source: Vue SFC (.vue files)              Dev Tool: Node 20+  │
│   Uses: Vue runtime-only build              Output: IIFE 250KB  │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ examples/react-demo-app                     Build Tool: Vite    │
│   Full React app with bundler               Framework: React 18 │
│                                                                  │
│ examples/vue-demo-app                       Build Tool: Vite    │
│   Full Vue app with bundler                 Framework: Vue 3    │
│                                                                  │
│ examples/vanilla-demo-app                   Build Tool: (none)  │
│   HTML + prebuilt core library              Framework: Vanilla  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 5. Data Flow: Package → Drupal Module

```
CURRENT MANUAL PROCESS
════════════════════════════════════════════════════════════════

Core Package Flow:
───────────────────
packages/dkan-client-tools-core/
  ↓
  npm run build (tsup)
  ↓
  dist/index.global.min.js (40KB)
  ↓
  [MANUAL] cp dist/index.global.min.js \
              ../../dkan/docroot/modules/custom/dkan_client_tools_core_base/js/vendor/dkan-client-tools-core.min.js
  ↓
  dkan_client_tools_core_base/js/vendor/dkan-client-tools-core.min.js (40KB)
  ↓
  Drupal loads via libraries.yml
  ↓
  Browser: window.DkanClientTools


React Package Flow:
───────────────────
packages/dkan-client-tools-react/
  ↓
  npm run build (tsup)
  ↓
  dist/index.global.min.js (205KB)
  ↓
  [MANUAL] cp dist/index.global.min.js \
              ../../dkan/docroot/modules/custom/dkan_client_tools_react_base/js/vendor/dkan-client-tools-react.min.js
  ↓
  dkan_client_tools_react_base/js/vendor/dkan-client-tools-react.min.js (205KB)
  ↓
  Drupal loads via libraries.yml
  ↓
  Browser: window.DkanClientToolsReact


Vue Package Flow:
─────────────────
packages/dkan-client-tools-vue/
  ↓
  npm run build (tsup - 5 configs)
  ↓
  dist/index.global.full.min.js (240KB)
  dist/index-runtime.global.runtime.min.js (174KB)
  ↓
  [MANUAL] cp dist/index.global.full.min.js \
              ../../dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/dkan-client-tools-vue.min.js
  [MANUAL] cp dist/index-runtime.global.runtime.min.js \
              ../../dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/dkan-client-tools-vue-runtime.min.js
  ↓
  dkan_client_tools_vue_base/js/vendor/
    ├── dkan-client-tools-vue.min.js (240KB)
    └── dkan-client-tools-vue-runtime.min.js (174KB)
  ↓
  Drupal loads via libraries.yml
  ↓
  Browser: window.DkanClientToolsVue


Demo Widget Flow (React):
─────────────────────────
dkan_client_demo_react/
  ↓
  npm install (from package.json)
  ↓
  npm run build (Vite)
  ↓
  vite bundles src/jsx/ with external @dkan-client-tools/react
  ↓
  js/dataset-search-widget.min.js (486KB - includes React Query + widget)
  ↓
  Drupal block plugin loads widget + library dependencies
  ↓
  Browser:
    1. Loads window.DkanClientTools (from core base module)
    2. Loads window.DkanClientToolsReact (from react base module)
    3. Loads window.DkanDatasetSearchWidget (from this module)


Demo Widget Flow (Vue):
──────────────────────
dkan_client_demo_vue/
  ↓
  npm install (from package.json)
  ↓
  npm run build (Vite with @vitejs/plugin-vue)
  ↓
  vite pre-compiles .vue templates to render functions
  ↓
  js/dataset-search-component.js (250KB - Vue templates pre-compiled)
  ↓
  Drupal block plugin loads widget + library dependencies
  ↓
  Browser:
    1. Loads window.DkanClientTools (from core base module)
    2. Loads window.DkanClientToolsVue (from vue base module)
    3. Executes pre-compiled render functions from this module
```

---

## 6. Format Decision Tree

```
Need to use DKAN Client Tools in a project?
│
├─ If: Bundler environment (npm/webpack/vite/etc)
│  └─ Use: ESM or CJS imports
│     packages/dkan-client-tools-{core|react|vue}/dist/index.{js|cjs}
│
├─ If: Browser/HTML/Drupal (no bundler)
│  └─ Use: IIFE global
│
│  ├─ For vanilla JavaScript
│  │  └─ Use: @dkan-client-tools/core IIFE
│  │     window.DkanClientTools
│  │
│  ├─ For React
│  │  └─ Use: @dkan-client-tools/react IIFE (self-contained)
│  │     window.DkanClientToolsReact
│  │     (includes React + ReactDOM + React Query + hooks)
│  │
│  └─ For Vue
│     ├─ If: Runtime template strings (template: 'html')
│     │  └─ Use: Full build WITH compiler (240KB)
│     │     window.DkanClientToolsVue (from .global.full.min.js)
│     │
│     └─ If: Pre-compiled templates (render functions)
│        └─ Use: Runtime-only build (174KB)
│           window.DkanClientToolsVue (from .global.runtime.min.js)
│
└─ In Drupal:
   └─ Base modules provide global objects via libraries.yml
      └─ Demo modules depend on base modules
         └─ Widgets use externalised libraries
```

---

## 7. File Mapping Table

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Source → Destination File Mapping                                           │
├──────────────────────────────────────┬──────────────────────────────────────┤
│ Source File                          │ Destination (Drupal Module)          │
├──────────────────────────────────────┼──────────────────────────────────────┤
│ packages/dkan-client-tools-core/     │ dkan_client_tools_core_base/         │
│   dist/index.global.min.js           │   js/vendor/dkan-client-tools-core.  │
│   (40KB)                             │          min.js (40KB)               │
├──────────────────────────────────────┼──────────────────────────────────────┤
│ packages/dkan-client-tools-react/    │ dkan_client_tools_react_base/        │
│   dist/index.global.min.js           │   js/vendor/dkan-client-tools-react. │
│   (205KB)                            │          min.js (205KB)              │
├──────────────────────────────────────┼──────────────────────────────────────┤
│ packages/dkan-client-tools-vue/      │ dkan_client_tools_vue_base/          │
│   dist/index.global.full.min.js      │   js/vendor/dkan-client-tools-vue.   │
│   (240KB)                            │          min.js (240KB)              │
│                                      │                                      │
│   dist/index-runtime.global.         │   js/vendor/dkan-client-tools-vue-   │
│          runtime.min.js              │          runtime.min.js (174KB)      │
│   (174KB)                            │                                      │
├──────────────────────────────────────┼──────────────────────────────────────┤
│ dkan_client_demo_react/              │ (No copy, built in place)            │
│   src/jsx/dataset-search-widget.jsx  │                                      │
│   (Vite build creates)               │ js/dataset-search-widget.min.js      │
│   (486KB)                            │ (486KB, generated)                   │
├──────────────────────────────────────┼──────────────────────────────────────┤
│ dkan_client_demo_vue/                │ (No copy, built in place)            │
│   src/DatasetSearchWidget.vue        │                                      │
│   (Vite build creates)               │ js/dataset-search-component.js       │
│   (250KB)                            │ (250KB, generated)                   │
└──────────────────────────────────────┴──────────────────────────────────────┘
```

---

## 8. Build Commands Reference

```
ROOT BUILD COMMANDS
═══════════════════════════════════════════════════════════════

npm run build              # Build all packages (tsup)
npm run dev                # Watch mode for all packages
npm run test               # Run 300+ tests
npm run typecheck          # TypeScript checking
npm run clean              # Clean all dist/ directories


INDIVIDUAL PACKAGE BUILD
═══════════════════════════════════════════════════════════════

cd packages/dkan-client-tools-core
npm run build              # Creates: dist/index.{js,cjs,global.js,global.min.js}
npm run dev                # Watch mode

cd packages/dkan-client-tools-react
npm run build              # Creates: dist/index.{js,cjs,global.js,global.min.js}
npm run dev                # Watch mode

cd packages/dkan-client-tools-vue
npm run build              # Creates: dist/index.{js,cjs,global.full.js,...}
npm run dev                # Watch mode


DEMO MODULE BUILD (HAS PACKAGE.JSON)
═══════════════════════════════════════════════════════════════

cd dkan/docroot/modules/custom/dkan_client_demo_react
npm install                # Install dependencies
npm run build              # Creates: js/dataset-search-widget.min.js
npm run watch              # Watch mode

cd dkan/docroot/modules/custom/dkan_client_demo_vue
npm install                # Install dependencies
npm run build              # Creates: js/dataset-search-component.js
npm run watch              # Watch mode


DRUPAL CLEANUP & CACHE
═══════════════════════════════════════════════════════════════

cd dkan
ddev drush cr              # Clear Drupal cache


FULL BUILD WORKFLOW (CURRENT MANUAL)
═══════════════════════════════════════════════════════════════

# Step 1: Build packages
npm run build

# Step 2: Copy base libraries to Drupal (MANUAL)
cp packages/dkan-client-tools-core/dist/index.global.min.js \
   dkan/docroot/modules/custom/dkan_client_tools_core_base/js/vendor/

cp packages/dkan-client-tools-react/dist/index.global.min.js \
   dkan/docroot/modules/custom/dkan_client_tools_react_base/js/vendor/

cp packages/dkan-client-tools-vue/dist/index.global.full.min.js \
   dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/dkan-client-tools-vue.min.js

cp packages/dkan-client-tools-vue/dist/index-runtime.global.runtime.min.js \
   dkan/docroot/modules/custom/dkan_client_tools_vue_base/js/vendor/dkan-client-tools-vue-runtime.min.js

# Step 3: Build demo modules
cd dkan/docroot/modules/custom/dkan_client_demo_react && npm install && npm run build
cd dkan/docroot/modules/custom/dkan_client_demo_vue && npm install && npm run build

# Step 4: Clear cache
cd dkan && ddev drush cr
```

---

## 9. Technology Stack Summary

```
PACKAGES (Framework-agnostic & Framework-specific)
───────────────────────────────────────────────────────────────
│ dkan-client-tools-core                                       │
│   ├─ TypeScript 5.3                                          │
│   ├─ TanStack Query Core 5.90                                │
│   ├─ tsup (build tool)                                       │
│   └─ Vitest (testing)                                        │
│                                                               │
│ dkan-client-tools-react                                      │
│   ├─ TypeScript 5.3                                          │
│   ├─ React 18.2                                              │
│   ├─ TanStack React Query 5.90                               │
│   ├─ tsup (build tool)                                       │
│   └─ Vitest + React Testing Library (testing)                │
│                                                               │
│ dkan-client-tools-vue                                        │
│   ├─ TypeScript 5.3                                          │
│   ├─ Vue 3.4                                                 │
│   ├─ TanStack Vue Query 5.x                                  │
│   ├─ tsup (build tool)                                       │
│   └─ Vitest + Vue Test Utils (testing)                       │
└───────────────────────────────────────────────────────────────

STANDALONE DEMO APPS
───────────────────────────────────────────────────────────────
│ react-demo-app                                               │
│   ├─ Vite 7 (dev/build)                                      │
│   ├─ React 18                                                │
│   ├─ TypeScript                                              │
│   └─ Tailwind CSS                                            │
│                                                               │
│ vue-demo-app                                                 │
│   ├─ Vite 7 (dev/build)                                      │
│   ├─ Vue 3                                                   │
│   ├─ TypeScript                                              │
│   └─ Tailwind CSS                                            │
│                                                               │
│ vanilla-demo-app                                             │
│   ├─ HTML + DKAN Client Tools Core (via CDN/local)          │
│   └─ Plain JavaScript                                        │
└───────────────────────────────────────────────────────────────

DRUPAL INTEGRATION
───────────────────────────────────────────────────────────────
│ dkan_client_demo_react (Drupal module)                       │
│   ├─ Vite 7 (demo widget build)                              │
│   ├─ React 18                                                │
│   ├─ @vitejs/plugin-react                                    │
│   ├─ Drupal Block Plugin                                     │
│   └─ Drupal Behaviors                                        │
│                                                               │
│ dkan_client_demo_vue (Drupal module)                         │
│   ├─ Vite 7 (demo widget build)                              │
│   ├─ Vue 3 with Vue SFCs                                     │
│   ├─ @vitejs/plugin-vue                                      │
│   ├─ Drupal Block Plugin                                     │
│   └─ Drupal Behaviors                                        │
│                                                               │
│ dkan_client_demo_vanilla (Drupal module)                     │
│   ├─ Plain JavaScript (no build)                             │
│   ├─ Drupal Block Plugin                                     │
│   └─ Drupal Behaviors                                        │
│                                                               │
│ DKAN (Drupal site)                                           │
│   ├─ Drupal 11.2.7                                           │
│   ├─ DKAN 2.21.2                                             │
│   ├─ DDEV (local development)                                │
│   ├─ MariaDB 10.11                                           │
│   └─ PHP 8.3                                                 │
└───────────────────────────────────────────────────────────────
```

---

## 10. Improvement Opportunities Summary

```
CURRENT STATE                          OPPORTUNITY
─────────────────────────────────────  ──────────────────────────────
Manual copying of built packages      → Automated copy script or npm hook
                                      → Unified build command

No root orchestration of builds       → Root script that builds packages
                                      → AND copies to Drupal modules
                                      → AND builds demo modules
                                      → AND clears cache

Version mismatch risk                 → Automated version sync
                                      → metadata in package.json

Unclear dependencies                  → Documented dependency graph
                                      → Build manifest file

Demo modules scattered                → Consider monorepo approach
                                      → Or centralized demo config

Vue build complexity                  → Document which builds used where
                                      → Simplify to 1-2 main builds

Watch mode difficult                  → Combined watch that rebuilds
                                      → AND re-copies automatically
                                      → AND restarts Drupal if needed

Build output hidden                   → Progress indicators
                                      → Build manifest/summary report

CI/CD ready?                          → GitHub Actions workflow
                                      → Automated testing + deploy
                                      → Version tagging

Documentation scattered               → Single source of truth
                                      → Visual diagrams (this document!)
```

